#!/bin/bash
#
# configure_cuda
#   Build & install SUNDIALS/CVODE with CUDA (NVECTOR_CUDA).
#
# NOTE:
#   - This script must be run on a CUDA-capable system (Linux HPC / workstation).
#   - macOS does NOT provide a CUDA environment; keep this script for reference/CI only.
#
# Requirements on the build machine:
#   - NVIDIA CUDA Toolkit (nvcc in PATH)
#   - CMake >= 3.18 (for CMAKE_CUDA_ARCHITECTURES)
#
# Customization (env vars):
#   - SUNDIALS_PREFIX : install prefix (default: $HOME/sundials)
#   - CUDA_ARCHS      : CMake CUDA arch list (default: 70;75;80;86;89;90)
#     Examples: "80" or "70;75;80;86"
#
SUNDIALS_PREFIX="${SUNDIALS_PREFIX:-${HOME}/sundials}"
CUDA_ARCHS="${CUDA_ARCHS:-70;75;80;86;89;90}"

installPath="InstallSundialsCUDA"
tarball="cvode-6.0.0.tar.gz"
srcdir="cvode-6.0.0"
url="https://github.com/LLNL/sundials/releases/download/v6.0.0/${tarball}"

echo "Trying to download and install SUNDIALS/CVODE with CUDA (NVECTOR_CUDA)."
echo ""
echo "Install prefix: ${SUNDIALS_PREFIX}"
echo "CUDA archs    : ${CUDA_ARCHS}"
echo ""

rm -rf "${installPath}"

if [ ! -f "${tarball}" ]; then
  echo "Downloading ${tarball}"
  if command -v curl >/dev/null 2>&1; then
    curl -L "${url}" -o "${tarball}"
  elif command -v wget >/dev/null 2>&1; then
    wget -c "${url}" -O "${tarball}"
  else
    echo "ERROR: need curl or wget to download ${tarball}"
    exit 1
  fi
fi

rm -rf "${srcdir}"
echo "tar xvf ${tarball}"
tar xvf "${tarball}"

mkdir -p "${installPath}/builddir"
echo "cd ${installPath}/builddir"
cd "${installPath}/builddir" || exit 1

echo "start configure...."
cmake -DCMAKE_INSTALL_PREFIX="${SUNDIALS_PREFIX}" \
 -DEXAMPLES_INSTALL_PATH="${SUNDIALS_PREFIX}/example" \
 -DBUILD_CVODE=ON \
 -DBUILD_CVODES=OFF \
 -DBUILD_ARKODE=OFF \
 -DBUILD_IDA=OFF \
 -DBUILD_IDAS=OFF \
 -DBUILD_KINSOL=OFF \
 -DOPENMP_ENABLE=ON \
 -DENABLE_CUDA=ON \
 -DCMAKE_CUDA_ARCHITECTURES="${CUDA_ARCHS}" \
 "../../${srcdir}"

echo "make"
make

echo "make install"
make install

echo ""
echo "Done."
echo "Verify CUDA NVECTOR library exists:"
echo "  ls \"${SUNDIALS_PREFIX}/lib\" | rg 'nveccuda|cudart' (or use ls/grep)"
